var minX=null;var maxX=null;var minY=null;var maxY=null;Designer.events.addEventListener("initialized",function(){var a=$("#view_container");if(document.getElementById("support_canvas").getContext){b(function(g){if(g.page.backgroundColor){$("#view_container").css("background-color","rgb("+g.page.backgroundColor+")")}Designer.open(g);Designer.hotkey.cancel();Designer.op.cancel();Designer.contextMenu.destroy();var e=$("#designer_canvas");e.children(".shape_box").each(function(){var i=$(this);var j=i.position();var h=j.left+i.width();var d=j.top+i.height();if(minX==null||j.left<minX){minX=j.left}if(maxX==null||h>maxX){maxX=h}if(minY==null||j.top<minY){minY=j.top}if(maxY==null||d>maxY){maxY=d}});var c=maxX-minX;if(c<a.width()){e.css("left",(a.width()-maxX-minX)/2)}else{e.css("left",-minX+50)}var f=maxY-minY;if(f<a.height()){e.css("top",(a.height()-maxY-minY)/2)}else{e.css("top",-minY+50)}})}function b(c){$.get("/diagraming/getdef?tempId="+tempId,{id:chartId},function(e){c(JSON.parse(e.def))})}});$(function(){initChartOperate();initCommentPost();if(!document.getElementById("support_canvas").getContext){$("#designer_canvas").empty().append("<img src='/chart_image/id/"+chartId+".png'/>")}warnUserClone()});function initChartOperate(){g();$(window).on("resize.view",function(){g()});var a=$("#view_container");function g(){var i=$(window).height();$("#view_container").height(i-53)}$(".mind-view-left").css({width:$(".mind-view-left").innerWidth(),left:0});$(".item[share]").on("click",function(){var h=$(".pop-con.share"),i=$(this);if(h.css("opacity")==1){h.css({opacity:0,right:-446});i.removeClass("active")}else{h.css({opacity:1,display:"block",right:"2px"});i.addClass("active")}zhuge.track("点击分享到社交网络",{"触发位置":"文件预览"})});$(".con-close").on("click",function(){var h=$(".pop-con");h.css({opacity:0,display:"none",right:-446});$(".item[share]").removeClass("active")});$(".viewtitle .down").on("click",function(){var h=$(this);if($(".chart-des").is(":visible")){$(".chart-des").hide();h.html("&#xe617;");$(".chart-pubtime").hide()}else{h.html("&#xe68d;");$(".chart-des").show();$(".chart-pubtime").show()}});$("#userlike").on("click",function(){doLikeChart(this)});$("#userfav").on("click",function(){doFavourite()});$("#userReport").on("click",function(){$("#report-page").dialog();$("#btn_submit_report").enable().off().on("click",function(){var h=$("#report_content").val();if(!h){Util.globalTopTip("举报信息不能为空","top_error",3000,$("#report-page"),true);return}else{if(h.length>200){Util.globalTopTip("举报信息不能超过200个字符","top_error",3000,$("#report-page"),true);return}}$(this).disable();Util.ajax({url:"/view/report",data:{chartId:chartId,content:h},success:function(i){Util.globalTopTip("您的举报信息已提交",null,3000,$("#report-page"),true);setTimeout(function(){$("#report-page").dialog("close")},3000)}})})});$(".controlls,.info-temp,.view-nav").on("mousedown",function(h){h.stopPropagation()});$("#view_container").on("touchstart",function(j){var m=j.originalEvent.changedTouches[0];var l=m.pageX;var h=m.pageY;$("#view_container").css("cursor","move");var k=$("#canvas").position().left/zoom;var i=$("#canvas").position().top/zoom;$("#view_container").on("touchmove",function(p){var o=p.originalEvent.changedTouches[0];var n=o.pageX-l;var q=o.pageY-h;p.preventDefault();$("#canvas").css({left:k+n/zoom+"px",top:i+q/zoom+"px"})});$("#view_container").on("touchend",function(n){$("#view_container").off("touchmove");$("#view_container").off("touchend");$("#view_container").css("cursor","default")})});var b=$("#view_container")[0];var e=b.requestFullScreen||b.webkitRequestFullScreen||b.mozRequestFullScreen||b.msRequestFullScreen;if(e){$("#view_container").unbind("webkitfullscreenchange").bind("webkitfullscreenchange",function(h){toogleFullDocument()});$(document).unbind("mozfullscreenchange").unbind("fullscreenchange").bind("mozfullscreenchange",function(h){toogleFullDocument()}).bind("fullscreenchange",function(h){toogleFullDocument()});$("#op_fullscreen").bind("click",function(h){e.call(b)});$(window).bind("keydown",function(h){if(h.keyCode==122){e.call(b);h.preventDefault()}})}else{$("#op_fullscreen").bind("click",function(h){hintTip("当前浏览器不支持全屏操作，请使用其他浏览器尝试",2000);return});$(window).bind("keydown",function(h){if(h.keyCode==122){return}})}$("#op_zoomin").bind("click",function(){zoomin()});$("#op_zoomout").bind("click",function(){zoomout()});$(document).on("mousewheel DOMMouseScroll",function(i){var h=i.originalEvent.wheelDelta||-i.originalEvent.detail;var j=Math.max(-1,Math.min(1,h));if(i.ctrlKey||i.metaKey){scrolling=true;i.preventDefault();if(j<0){zoomout()}else{zoomin()}}});$("#view_container").bind("dragstart",function(){return false});$("#view_container").css("backgroundColor",$("#designer_canvas").css("backgroundColor"));$("#view_container").mousedown(function(i){var l=i.pageX;var h=i.pageY;$("#view_container").css("cursor","move");var k=$("#designer_canvas").position().left;var j=$("#designer_canvas").position().top;$(document).bind("mousemove.drag",function(n){var m=n.pageX-l;var o=n.pageY-h;$("#designer_canvas").css({left:k+m+"px",top:j+o+"px"})});$(document).mouseup(function(m){$(document).unbind("mousemove.drag");$(document).unbind("mouseup");$("#view_container").css("cursor","default")})});var f=true;var d=false;$(".viewtitle .show-item").on("click",function(){if(f==false){return}sliding("infoTemp");f=false;if(!d){templates()}d=true;setTimeout(function(){f=true},500)});var c=false;$(".item[comment]").off().on("click",function(){if(f==false){return}if(!$(this).hasClass("active")&&$(".pop-con.share").css("opacity")==1){$(".share .con-close").trigger("click");$(".weixin-con").css("display","none")}sliding("controlls");f=false;if(!c){loadComments()}c=true;setTimeout(function(){f=true},500)});$(".info-temp .item-close").on("click",function(){$(".viewtitle .show-item").trigger("click")});$(".controlls .item-close").on("click",function(){$(".item[comment]").trigger("click")});window.onresize=function(){if($(".item[comment]").hasClass("active")&&$(".info-temp").css("left")=="0px"){$(".mind-view-left").css("width",$("body").innerWidth()-700)}else{if($(".item[comment]").hasClass("active")||$(".info-temp").css("left")=="0px"){$(".mind-view-left").css("width",$("body").innerWidth()-350)}else{$(".mind-view-left").css("width","100%")}}};$("#comment").on("input",function(){if($(this).html()==""){$(this).html("<br/>")}});$(".mind-view-left,.textarea").on("click",function(){replyHide()})}function replyHide(){$(".reply_box_ref").slideUp(200,function(){$(".reply_box_ref").remove()})}function zoomin(){zoom+=0.1;Designer.setZoomScale(zoom)}function zoomout(){if(zoom<=0.4){return}zoom-=0.1;Designer.setZoomScale(zoom)}var comArr=[];function sliding(b){if(comArr.indexOf(b)==-1){comArr.push(b)}else{comArr.remove(b)}var a=$(".mind-view-left").innerWidth();controllsTagger(b,a);dable=false}function controllsTagger(b,a){if(b=="controlls"){if(comArr.indexOf("controlls")!=-1){$(".item[comment]").addClass("active");$(".mind-view-left").css("width",a-350);$(".controlls").css("right",0)}else{$(".item[comment]").removeClass("active");$(".mind-view-left").css("width",a+350);$(".controlls").css("right",-350)}$(".outline-dlg").css("width","100%")}if(b=="infoTemp"){if(comArr.indexOf("infoTemp")!=-1){setTimeout(function(){$(".info-temp").css("left",0);$(".mind-view-left").css({left:350,width:a-350})},0)}else{$(".info-temp").css("left",-350);$(".mind-view-left,.outline-dlg").css({left:0,width:a+350})}$(".outline-dlg").css("width","100%")}setTimeout(function(){$("#movecenter").trigger("click")},300)}var showTiping=null;function hintTip(c,a,e,d){var b=$("#mind-tip");if(c=="close"){b.remove();return}if(b.length==0){b=$("<div id='mind-tip'><div class='mind-tip-text'></div></div>").appendTo("body");b.append("<div class='mind-tip-close mind-icons'></div>");b.children(".mind-tip-close").on("click",function(){hintTip("close")})}if(d){b.children(".mind-tip-close").on("click.callback",function(){d()})}else{b.children(".mind-tip-close").unbind("click.callback")}b.children(".mind-tip-text").html(c);b.css({marginLeft:-b.width()/2-30});if(e!=null&&e=="left_bottom"){b.show().css({bottom:100,left:25,marginLeft:"0",top:"initial"})}else{b.show().css({top:60})}if(a!=null&&showTiping==null){showTiping=setTimeout(function(){hintTip("close");showTiping=null},a)}}function templates(){var a=[];Util.ajax({url:"/special/query",data:{page:1,sidx:"order",sord:"asc"},success:function(b){a=b.rows;if(a.length>0){specials(a)}}})}function specials(b){var a=[];Util.ajax({url:"/special/chart_view?chartId="+chartId,data:{},success:function(g){if(!g.id){a='<div class="special-empty"><div class="empty-text">该模版暂未收入任何专题</div><a class="special-link" href="/diagrams/new#temp-template">去专题页看看</a></div>';$(".special-conent").html(a)}else{for(var d=0;d<b.length;d++){for(var c=0;c<g.id.length;c++){if(b[d].specialId==g.id[c]){var f=b[d];var h=f.viewCount;if(h-0>1000){h=(h/1000).toFixed(1)+"k"}a.push('<a href="/diagrams/new#temp-template?id='+f.specialId+'"><div class="wrapper-banner-item"><div class="wrapper-item-img new_Hash" data-id = "'+f.specialId+'" data-allowPublish = "'+f.allowPublish+'" data-url="temp-template" ><img data-src= "'+f.banner+'" src="'+imagePath+"/file/response/"+f.thumbnail+'/special_image" alt="图片加载失败" /> <div class="wrapper-item-mask"><span class="mask-img"></span></div><div class="item-mask-text"><span class="icons">&#xe68c;</span><span>'+h+"</span></div></div></div></a>")}}}$(".special-conent").html(a.join(""))}},error:function(){a='<div class="special-empty"><div class="empty-text">该模版暂未收入任何专题</div><a class="special-link" href="/diagrams/new#temp-template">去专题页看看</a></div>';$(".special-conent").html(a)}})}var zoom=1;function increaseZoomScale(h){if(zoom<=0.4){return}var b=$("#view_container");var c=$("#designer_canvas");var a={x:b.width()/2,y:b.height()/2};var g=a.x-c.position().left;var e=a.y-c.position().top;var f=g*(1+h);var d=e*(1+h);c.css({left:a.x-f,top:a.y-d});zoom+=h;Designer.setZoomScale(zoom)}var isFullScreen=false;function toogleFullDocument(b){isFullScreen=!isFullScreen;if(isFullScreen){fullDocument()}else{exitFullDocument()}var a=$("#op_fullscreen").parent();if(isFullScreen){if(typeof b!="undefined"){a.show()}else{a.hide()}}else{a.show()}}function fullDocument(){$("#view_container").addClass("full_document");$("#view_container").css({height:window.screen.height});$("body").addClass("overhidden");$(".ico_fullscreen").addClass("exit")}function exitFullDocument(){$("#view_container").removeClass("full_document");$("#view_container").css({height:$(window).height()-53});$("body").removeClass("overhidden");$(".ico_fullscreen").removeClass("exit")}var chartCloning=false;function newCreateConfirm(a){if(chartCloning){return}chartCloning=true;Util.loadingball({});Util.ajax({url:"/diagraming/clone_check",data:{chartId:a,teamId:cteamId,orgId:corgId},success:function(b){Util.loadingball({close:true});if(b.result=="clone"){location="/diagraming/new?template="+a+"&team="+cteamId+"&org="+corgId;return}chartCloning=false;if(b.result=="cloneBuy"){Util.payWindow("open",{chartId:a,price:b.price},function(){});return}if(b.result=="overd"){Util.globalTopTip("您的文件数量不足，无法克隆,您可以去 <a href='/upgrade' target='_blank'>升级账号</a>","top_error",5000);return}Util.globalTopTip("操作有误，请稍后再试","top_error",5000)}})}function initCommentPost(){$("#comment").bind("keydown",function(a){if(a.ctrlKey&&a.keyCode==13){submitComment()}}).streamInput({face:$("#showFaces")});$("#btn-comment").off().on("click",function(a){if($(this).attr("disabled")){return}submitComment();a.stopPropagation()})}function submitComment(d,c,f,e){var a=$("#comment").clone();if(d!=null){a=d}var b=a.html().replace(/<img(\s|\S)+?src=\"/g,":lt: class=ico-face src=").replace(/\">/g,":gt:").trim();b=Util.filterXss(b);if(b=="&lt;br&gt;"||b==""){return}else{$("#btn-comment").attr("disabled","disabled");Util.ajax({url:"/view/submitcomment",data:{chartId:chartId,content:b,ownerId:ownerId,refId:c,parentId:f},success:function(i){if(i.result=="error_text"){Util.globalTopTip("描述或标签中存在敏感词汇，请修改后再发布","top_error",3000,$(".controlls"),true);return}var g=$("#comment_count"),h=parseInt(g.text())+1;g.text(h);$("#comment-count").text(numberHandle(h));if(f){var j=$(".reply_list li[data-id="+f+"]");j.find(".replies").append(i)}else{$(".reply_list").append(i);$(".repler-right").scrollTop(9999)}$("#btn-comment").removeAttr("disabled");$("#comment").html("<br/>");checkCommentCount();a.remove();if(e!=null){e()}}})}}function commentRef(b,a,e){var d=$(b).parent().next(".reply_box_ref");$(".reply_box_ref").not(d).remove();if(d.length==0){d=$("<div class='reply_box_ref'><div class='white_line'></div>回复此评论：<div class='txt text-input' contentEditable='true' spellcheck='false' id='reply-input' accesskey='q' style='min-height:20px;line-height:20px;padding:0 5px'></div><span  class='button' >发表评论</span><span id='showfaces-reply' class='icons'>&#xe70e;</span></div>");$(b).parent().after(d);$(b).parent().next(".reply_box_ref").attr({id:a,pId:e});function c(){var f=d.children(".txt");submitComment(f,a,e,function(){d.remove()})}d.children(".txt").bind("keydown",function(f){if(f.ctrlKey&&f.keyCode==13){submitComment()}}).streamInput({face:$("#showfaces-reply")});d.children(".button").off().on("click",function(){c()})}if(d.is(":visible")){d.slideUp(200,function(){$(".reply_box_ref").remove()})}else{d.slideDown(200);d.find(".txt").focus()}}function openDeldia(d,b,c){var a=$("#stream_delete_confirm");if(a.length==0){a=$("<div id='stream_delete_confirm' class='alert' style='top:490px'>确认删除此条评论吗？<div class='stream_delete_btns'><span class='button ok'>确定</span>&nbsp;&nbsp;&nbsp;<span class='cancel'>取消</span><div></div>").appendTo("body")}a.popMenu({target:$(c),position:"center",zindex:19});a.find(".cancel").off().on("mousedown",function(){a.popMenu("close")});a.find(".ok").off().on("mousedown",function(f){Util.ajax({url:"/view/delComments",data:{refId:b,chartId:chartId,parentId:d},success:function(h){var e="";if($(c).parents("div").hasClass("reply_list-item")){e=1;$(c).parents(".reply_list-item").remove()}else{e=$(c).parents("li").find("li").length+$(c).parents("li").find(".reply_list-item").length+1;$(c).parents("li").remove()}var i=$("#comment_count"),g=Number(i.text())-e;i.text(g);$("#comment-count").text(numberHandle(g));checkCommentCount()}});a.popMenu("close")})}function showFaces(c,b){var a=$("#faces_dialog"),d=b||$("#comment");if(a.length>0){a.popMenu({target:c,position:"right",zindex:19});return}var a=$('<div id="faces_dialog" class="faces-lib"><ul><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><div class="clear"></div></ul></div>');a.appendTo("body");a.popMenu({target:c,position:"right"});a.find("li").on("mousedown",function(h){var g=$(this).index();var f="<img class='ico-face' src='/assets/images/faces/faces/"+(g+1)+".gif' />";d.append(f);a.popMenu("close");h.stopPropagation()})}var currentSkip=-15;function loadComments(){currentSkip+=15;Util.ajax({url:"/view/loadcomments",data:{chartId:chartId,skip:currentSkip,ownerId:ownerId},success:function(c){$(".reply_list").append(c);var e=$(".item[comment] .item-count").text();var b=$(".reply_list").find("li").length+$(".reply_list-item").length;if(currentSkip>=15){var a=$(".repler-right").scrollTop();var d=setInterval(function(){a+=150;if(a>=$(".repler-right").scrollTop()+$(".repler-right").innerHeight()){clearInterval(d)}$(".repler-right").scrollTop(a)},40)}if(b>=15){$(".load_more").show()}if($.trim(c)==""||e==b){$(".load_more").hide()}checkCommentCount()}})}function checkCommentCount(){var b=$(".reply_list");if($.trim(b.text())==""){var a="<div class='empty-tip'><div class='empty-img' style='margin-bottom:20px;'><img src='/assets/images/empty.png'></img></div><span class='tip-text'>评论区还是空的</span><span id='none-tip' style='display:block;color:#ADADAD;margin-top:10px;'>快来抢占沙发吧~</span></div>";b.html(a)}else{$(".empty-tip").remove()}}function doFavourite(){var a=$("#userfav");a.disable();if(a.hasClass("active")){a.numberTip({val:"-1"})}else{a.numberTip()}Util.ajax({url:"/view/favouriteChart",data:{chartId:chartId},success:function(d){a.enable();var e=a.find(".item-count"),c=Number(e.text());if(d.result=="save"){if(c<1000){e.text(c+1)}a.attr("class","item active");$(a).find(".ico_box .icons").html("&#xe6d4;")}else{if(c<1000){var b=c-1;e.text(b<0?0:b)}a.attr("class","item");$(a).find(".ico_box .icons").html("&#xe68a;")}}})}function doLikeChart(){var a=$("#userlike");a.disable();if(a.hasClass("active")){a.numberTip({val:"-1"})}else{a.numberTip()}Util.ajax({url:"/view/dolike",data:{chartId:chartId},success:function(b){a.enable();if(b.result){a.attr("class","item active");$(a).find(".ico_box .icons").html("&#xe6d5;")}else{a.attr("class","item");$(a).find(".ico_box .icons").html("&#xe6d1;")}a.find(".item-count").text(numberHandle(b.count))}})}function showWeixin(g){var f=$(g).offset().left;var e=$(g).offset().top;var c=window.location.href;var a=$("#pageurl_div");if(a.length>0){a.show();return}var d=$('<div id="pageurl_div" class="weixin-con"><img id="pageurl" src=""/><div>微信扫一扫 分享</div></div>');d.appendTo("body");var b="https://api.qrserver.com/v1/create-qr-code/?data="+c+"&show_wechat_share_tip=true&size=180x180";$("#pageurl").attr("src",b);$("#pageurl_div").css({right:"220px",top:"60px"}).show();$(document).on("mousedown",function(){$("#pageurl_div").hide()})}function warnUserClone(){var b=Util.getUrlParams("fromnew");if(!b==0){var c=$(".item-clone-opt"),a=c.length;if(a>0){$(".new-clone-tip").fadeIn();window.setTimeout(function(){$(".new-clone-tip").fadeOut()},5000)}}else{$(".new-clone-tip").hide()}};